<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TradingBot — Backtest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <!-- Chart.js for equity curve -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0c1118;          /* page */
    --panel: #111826;       /* cards */
    --panel-border: #243041;/* borders */
    --text: #e8edf3;        /* primary text */
    --text-muted: #b7c2cf;  /* secondary text */
    --table-head: #1a2332;
    --table-row: #121a28;
    --table-row-alt: #152032;
    --green: #17b26a;
    --green-ink: #062a1a;
    --red: #f04438;
    --red-ink: #2c0b0b;
    --blue: #3b82f6;
  }

  body { background: var(--bg); color: var(--text); }
  .muted { color: var(--text-muted); }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

  .card { background: var(--panel); border: 1px solid var(--panel-border); }
  .card .card-body { color: var(--text); }

  /* Table */
  .table-dark { --bs-table-color: var(--text); --bs-table-bg: transparent; }
  .table-dark thead th { background: var(--table-head); color: var(--text); border-color: var(--panel-border); }
  .table-dark tbody tr { background: var(--table-row); }
  .table-dark tbody tr:nth-child(odd) { background: var(--table-row-alt); }
  .table-dark td, .table-dark th { border-color: var(--panel-border); }

  /* Badges */
  .badge-up   { background: var(--green-ink); color: var(--text); border: 1px solid var(--green); }
  .badge-down { background: var(--red-ink);   color: var(--text); border: 1px solid var(--red); }

  /* Forms */
  .form-label { color: var(--text-muted); font-size: 0.875rem; }
  .form-control, .form-select {
    background: var(--panel);
    border: 1px solid var(--panel-border);
    color: var(--text);
  }
  .form-control:focus, .form-select:focus {
    background: var(--panel);
    border-color: var(--blue);
    color: var(--text);
  }

  /* Section headers */
  .section-title { color: var(--text); opacity: 0.95; }

  /* Metric cards */
  .metric-card {
    background: var(--table-row);
    border: 1px solid var(--panel-border);
    padding: 1rem;
    border-radius: 0.5rem;
  }
  .metric-label {
    color: var(--text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .metric-value {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 0.25rem;
  }

  /* Loading spinner */
  .spinner-border { border-color: var(--blue); border-right-color: transparent; }

  /* Nav tabs */
  .nav-tabs {
    border-bottom: 1px solid var(--panel-border);
  }
  .nav-tabs .nav-link {
    color: var(--text-muted);
    border: none;
    border-bottom: 2px solid transparent;
  }
  .nav-tabs .nav-link:hover {
    color: var(--text);
    border-bottom-color: var(--panel-border);
  }
  .nav-tabs .nav-link.active {
    color: var(--text);
    background: transparent;
    border-bottom-color: var(--blue);
  }
</style>

</head>
<body class="p-3">
  <div class="container-fluid">
    <!-- Header with nav -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 mb-0">TradingBot — Backtest</h1>
      <div class="d-flex gap-2">
        <a href="/ui" class="btn btn-sm btn-outline-light">Portfolio</a>
        <a href="/backtest-ui" class="btn btn-sm btn-primary">Backtest</a>
      </div>
    </div>

    <div class="row">
      <!-- Left: Configuration -->
      <div class="col-lg-4">
        <div class="card mb-3">
          <div class="card-body">
            <h2 class="h5 section-title mb-3">Configuration</h2>

            <form id="backtestForm">
              <div class="mb-3">
                <label for="strategy" class="form-label">Strategy</label>
                <select class="form-select" id="strategy" required>
                  <option value="">Select strategy...</option>
                  <option value="MeanReversion">Mean Reversion</option>
                  <option value="Breakout">Breakout</option>
                  <option value="TrendFollow">Trend Following</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="symbol" class="form-label">Symbol</label>
                <select class="form-select" id="symbol" required>
                  <option value="BTC_USDT">BTC_USDT</option>
                  <option value="ETH_USDT">ETH_USDT</option>
                  <option value="SOL_USDT">SOL_USDT</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="timeframe" class="form-label">Timeframe</label>
                <select class="form-select" id="timeframe" required>
                  <option value="1m">1 minute</option>
                  <option value="5m" selected>5 minutes</option>
                  <option value="15m">15 minutes</option>
                  <option value="30m">30 minutes</option>
                  <option value="1h">1 hour</option>
                  <option value="4h">4 hours</option>
                  <option value="1d">1 day</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="days" class="form-label">History (days)</label>
                <input type="number" class="form-control" id="days" value="30" min="1" max="365" required>
              </div>

              <div id="paramsSection" class="mb-3">
                <label class="form-label">Strategy Parameters</label>
                <div id="paramsInputs" class="text-muted small">
                  Select a strategy to see parameters
                </div>
              </div>

              <div class="mb-3">
                <label for="initialCapital" class="form-label">Initial Capital ($)</label>
                <input type="number" class="form-control" id="initialCapital" value="1000" min="100" step="100" required>
              </div>

              <div class="mb-3">
                <label for="minNotional" class="form-label">Min Trade Size ($)</label>
                <input type="number" class="form-control" id="minNotional" value="100" min="1" step="10" required>
              </div>

              <button type="submit" class="btn btn-primary w-100" id="runBtn">
                Run Backtest
              </button>
            </form>
          </div>
        </div>

        <!-- Quick presets -->
        <div class="card">
          <div class="card-body">
            <h2 class="h6 section-title mb-2">Quick Presets</h2>
            <div class="d-grid gap-2">
              <button class="btn btn-sm btn-outline-light text-start" onclick="loadPreset('mr-btc')">
                <strong>Mean Reversion</strong> • BTC • 5m • 30d
              </button>
              <button class="btn btn-sm btn-outline-light text-start" onclick="loadPreset('bo-eth')">
                <strong>Breakout</strong> • ETH • 5m • 30d
              </button>
              <button class="btn btn-sm btn-outline-light text-start" onclick="loadPreset('tf-sol')">
                <strong>Trend Follow</strong> • SOL • 5m • 30d
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Results -->
      <div class="col-lg-8">
        <!-- Loading state -->
        <div id="loadingState" class="card text-center py-5" style="display: none;">
          <div class="card-body">
            <div class="spinner-border mb-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted">Running backtest...</p>
          </div>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="card text-center py-5">
          <div class="card-body">
            <p class="text-muted mb-0">Configure and run a backtest to see results</p>
          </div>
        </div>

        <!-- Results -->
        <div id="resultsContainer" style="display: none;">
          <!-- Metrics Grid -->
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <div class="metric-card">
                <div class="metric-label">Total Return</div>
                <div class="metric-value mono" id="metricReturn">-</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card">
                <div class="metric-label">Sharpe Ratio</div>
                <div class="metric-value mono" id="metricSharpe">-</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card">
                <div class="metric-label">Max Drawdown</div>
                <div class="metric-value mono" id="metricDrawdown">-</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-card">
                <div class="metric-label">Win Rate</div>
                <div class="metric-value mono" id="metricWinRate">-</div>
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="card">
            <div class="card-body">
              <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item">
                  <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#equityTab">Equity Curve</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#metricsTab">All Metrics</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tradesTab">Trades</button>
                </li>
              </ul>

              <div class="tab-content">
                <!-- Equity Curve -->
                <div class="tab-pane fade show active" id="equityTab">
                  <canvas id="equityChart" style="max-height: 400px;"></canvas>
                </div>

                <!-- All Metrics -->
                <div class="tab-pane fade" id="metricsTab">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <table class="table table-sm table-dark">
                        <tbody id="metricsTable1"></tbody>
                      </table>
                    </div>
                    <div class="col-md-6">
                      <table class="table table-sm table-dark">
                        <tbody id="metricsTable2"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- Trades -->
                <div class="tab-pane fade" id="tradesTab">
                  <div class="table-responsive">
                    <table class="table table-sm table-dark table-striped">
                      <thead>
                        <tr>
                          <th>Time</th>
                          <th>Side</th>
                          <th>Qty</th>
                          <th>Price</th>
                          <th>Notional</th>
                        </tr>
                      </thead>
                      <tbody id="tradesTable"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let equityChart = null;

    // Strategy parameters configuration
    const strategyParams = {
      MeanReversion: [
        { name: 'lookback', label: 'Lookback Period', type: 'number', default: 50, min: 10, max: 200 },
        { name: 'band', label: 'Band Multiplier', type: 'number', default: 2.0, min: 0.5, max: 5, step: 0.1 },
        { name: 'confirm_bars', label: 'Confirmation Bars', type: 'number', default: 2, min: 1, max: 5 }
      ],
      Breakout: [
        { name: 'lookback', label: 'Lookback Period', type: 'number', default: 60, min: 10, max: 200 },
        { name: 'confirm_bars', label: 'Confirmation Bars', type: 'number', default: 2, min: 1, max: 5 }
      ],
      TrendFollow: [
        { name: 'fast', label: 'Fast MA Period', type: 'number', default: 20, min: 5, max: 100 },
        { name: 'slow', label: 'Slow MA Period', type: 'number', default: 100, min: 20, max: 300 },
        { name: 'confirm_bars', label: 'Confirmation Bars', type: 'number', default: 2, min: 1, max: 5 }
      ]
    };

    // Update parameter inputs when strategy changes
    document.getElementById('strategy').addEventListener('change', (e) => {
      const strategy = e.target.value;
      const container = document.getElementById('paramsInputs');

      if (!strategy || !strategyParams[strategy]) {
        container.innerHTML = '<div class="text-muted small">Select a strategy to see parameters</div>';
        return;
      }

      const params = strategyParams[strategy];
      container.innerHTML = params.map(p => `
        <div class="mb-2">
          <label for="param_${p.name}" class="form-label small">${p.label}</label>
          <input
            type="${p.type}"
            class="form-control form-control-sm"
            id="param_${p.name}"
            name="${p.name}"
            value="${p.default}"
            ${p.min !== undefined ? `min="${p.min}"` : ''}
            ${p.max !== undefined ? `max="${p.max}"` : ''}
            ${p.step !== undefined ? `step="${p.step}"` : ''}
            required
          />
        </div>
      `).join('');
    });

    // Form submission
    document.getElementById('backtestForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const strategy = document.getElementById('strategy').value;
      const symbol = document.getElementById('symbol').value;
      const timeframe = document.getElementById('timeframe').value;
      const days = parseInt(document.getElementById('days').value);
      const initialCapital = parseFloat(document.getElementById('initialCapital').value);
      const minNotional = parseFloat(document.getElementById('minNotional').value);

      // Collect strategy parameters
      const params = {};
      const paramInputs = document.querySelectorAll('#paramsInputs input');
      paramInputs.forEach(input => {
        const value = input.type === 'number' ? parseFloat(input.value) : input.value;
        params[input.name] = value;
      });

      // Show loading state
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('resultsContainer').style.display = 'none';
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('runBtn').disabled = true;
      document.getElementById('runBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Running...';

      try {
        const response = await fetch('/backtest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            strategy,
            params,
            symbol,
            timeframe,
            days,
            initial_capital: initialCapital,
            min_notional: minNotional
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Backtest failed');
        }

        displayResults(data);

      } catch (error) {
        alert('Error: ' + error.message);
        document.getElementById('emptyState').style.display = 'block';
      } finally {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('runBtn').disabled = false;
        document.getElementById('runBtn').textContent = 'Run Backtest';
      }
    });

    function displayResults(data) {
      const { metrics, equity_curve, trades, config } = data;

      // Show results container
      document.getElementById('resultsContainer').style.display = 'block';

      // Update key metrics
      const isPositive = metrics.total_return >= 0;
      document.getElementById('metricReturn').innerHTML = `<span style="color: ${isPositive ? 'var(--green)' : 'var(--red)'}">
        ${metrics.total_return >= 0 ? '+' : ''}${metrics.total_return.toFixed(2)}%
      </span>`;

      const sharpeGood = metrics.sharpe_ratio >= 1.0;
      document.getElementById('metricSharpe').innerHTML = `<span style="color: ${sharpeGood ? 'var(--green)' : 'var(--text)'}">
        ${metrics.sharpe_ratio.toFixed(2)}
      </span>`;

      const ddGood = metrics.max_drawdown <= 15;
      document.getElementById('metricDrawdown').innerHTML = `<span style="color: ${ddGood ? 'var(--green)' : 'var(--red)'}">
        ${metrics.max_drawdown.toFixed(2)}%
      </span>`;

      const wrGood = metrics.win_rate >= 50;
      document.getElementById('metricWinRate').innerHTML = `<span style="color: ${wrGood ? 'var(--green)' : 'var(--text)'}">
        ${metrics.win_rate.toFixed(2)}%
      </span>`;

      // Populate all metrics tables
      const metrics1 = [
        ['Total Return', `${metrics.total_return >= 0 ? '+' : ''}${metrics.total_return.toFixed(2)}%`],
        ['Sharpe Ratio', metrics.sharpe_ratio.toFixed(2)],
        ['Max Drawdown', `${metrics.max_drawdown.toFixed(2)}%`],
        ['Win Rate', `${metrics.win_rate.toFixed(2)}%`],
        ['Profit Factor', metrics.profit_factor.toFixed(2)],
        ['Total Trades', metrics.total_trades],
        ['Days', metrics.days]
      ];

      const metrics2 = [
        ['Winning Trades', metrics.winning_trades],
        ['Losing Trades', metrics.losing_trades],
        ['Avg Win', `$${metrics.avg_win.toFixed(2)}`],
        ['Avg Loss', `$${metrics.avg_loss.toFixed(2)}`],
        ['Avg Trade', `$${metrics.avg_trade.toFixed(2)}`],
        ['Max Consec Losses', metrics.max_consecutive_losses],
        ['Final Equity', `$${metrics.final_equity.toFixed(2)}`]
      ];

      document.getElementById('metricsTable1').innerHTML = metrics1.map(([label, value]) =>
        `<tr><td class="text-muted">${label}</td><td class="mono text-end">${value}</td></tr>`
      ).join('');

      document.getElementById('metricsTable2').innerHTML = metrics2.map(([label, value]) =>
        `<tr><td class="text-muted">${label}</td><td class="mono text-end">${value}</td></tr>`
      ).join('');

      // Render equity curve chart
      renderEquityChart(equity_curve, config);

      // Render trades table
      document.getElementById('tradesTable').innerHTML = trades.map(t => `
        <tr>
          <td class="mono small">${new Date(t.ts * 1000).toLocaleString()}</td>
          <td><span class="badge ${t.side === 'buy' ? 'badge-up' : 'badge-down'}">${t.side.toUpperCase()}</span></td>
          <td class="mono">${t.qty.toFixed(6)}</td>
          <td class="mono">$${t.price.toFixed(2)}</td>
          <td class="mono">$${t.notional.toFixed(2)}</td>
        </tr>
      `).join('');
    }

    function renderEquityChart(equityCurve, config) {
      const ctx = document.getElementById('equityChart');

      // Destroy previous chart if exists
      if (equityChart) {
        equityChart.destroy();
      }

      equityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: equityCurve.map(p => new Date(p.ts * 1000).toLocaleString()),
          datasets: [{
            label: 'Equity',
            data: equityCurve.map(p => p.equity),
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: `${config.strategy} • ${config.symbol} • ${config.timeframe} • ${config.days} days`,
              color: 'rgb(232, 237, 243)'
            },
            tooltip: {
              callbacks: {
                label: (context) => `Equity: $${context.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            x: {
              display: true,
              ticks: {
                maxTicksLimit: 10,
                color: 'rgb(183, 194, 207)'
              },
              grid: { color: 'rgba(36, 48, 65, 0.5)' }
            },
            y: {
              display: true,
              ticks: {
                color: 'rgb(183, 194, 207)',
                callback: (value) => '$' + value.toFixed(0)
              },
              grid: { color: 'rgba(36, 48, 65, 0.5)' }
            }
          }
        }
      });
    }

    // Quick presets
    function loadPreset(preset) {
      const presets = {
        'mr-btc': {
          strategy: 'MeanReversion',
          symbol: 'BTC_USDT',
          timeframe: '5m',
          days: 30,
          params: { lookback: 50, band: 2.0, confirm_bars: 2 }
        },
        'bo-eth': {
          strategy: 'Breakout',
          symbol: 'ETH_USDT',
          timeframe: '5m',
          days: 30,
          params: { lookback: 60, confirm_bars: 2 }
        },
        'tf-sol': {
          strategy: 'TrendFollow',
          symbol: 'SOL_USDT',
          timeframe: '5m',
          days: 30,
          params: { fast: 20, slow: 100, confirm_bars: 2 }
        }
      };

      const config = presets[preset];
      if (!config) return;

      document.getElementById('strategy').value = config.strategy;
      document.getElementById('strategy').dispatchEvent(new Event('change'));

      setTimeout(() => {
        document.getElementById('symbol').value = config.symbol;
        document.getElementById('timeframe').value = config.timeframe;
        document.getElementById('days').value = config.days;

        Object.entries(config.params).forEach(([key, value]) => {
          const input = document.getElementById(`param_${key}`);
          if (input) input.value = value;
        });
      }, 100);
    }
  </script>
</body>
</html>
