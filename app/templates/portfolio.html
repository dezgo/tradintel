{% extends "base.html" %}

{% block title %}TradingBot — Portfolio{% endblock %}
{% block page_title %}TradingBot — Portfolio{% endblock %}
{% set active_page = 'portfolio' %}

{% block extra_styles %}
  /* Badges (stronger contrast) */
  .badge-up   { background: #062a1a; color: var(--text); border: 1px solid var(--green); }
  .badge-down { background: #2c0b0b; color: var(--text); border: 1px solid var(--red); }
  .badge-active { background: #1e3a8a; color: var(--text); border: 1px solid var(--blue); }

  /* Section headers & muted bits */
  .section-title { color: var(--text); opacity: 0.95; }

  /* Custom select styling */
  .form-select-sm { background-color: var(--panel); color: var(--text); border-color: var(--panel-border); }
  .form-select-sm:focus { background-color: var(--panel); color: var(--text); border-color: var(--blue); }

  /* Worker status indicators */
  .status-active { color: var(--green); }
  .status-idle { color: var(--text-muted); }

  /* Collapsible sections */
  .collapse-toggle { cursor: pointer; user-select: none; }
  .collapse-toggle:hover { opacity: 0.8; }
{% endblock %}

{% block extra_nav %}
  <span class="muted small">Auto-refresh</span>
  <div class="form-check form-switch">
    <input class="form-check-input" type="checkbox" id="autoRefresh" checked />
  </div>
  <select id="interval" class="form-select form-select-sm" style="width:120px">
    <option value="3">3s</option>
    <option value="5" selected>5s</option>
    <option value="10">10s</option>
  </select>
  <button class="btn btn-sm btn-outline-light" id="refreshBtn">Refresh</button>
  <span class="mono small muted" id="tfTag"></span>
{% endblock %}

{% block content %}

  <!-- Top summary + (optional) live prices placeholder -->
  <div id="summary" class="mb-3"></div>
  <div id="prices" class="mb-3"></div>

  <!-- Global symbol filter (shared note area on right) -->
  <div class="card mb-3">
    <div class="card-body d-flex flex-wrap gap-3 align-items-center">
      <h2 class="h6 mb-0 section-title">Filter</h2>
      <div class="d-flex align-items-center gap-2">
        <label for="symFilter" class="muted small">Symbol</label>
        <select id="symFilter" class="form-select form-select-sm" style="width: 160px;">
          <option value="">All</option>
          <option>BTC_USDT</option>
          <option>ETH_USDT</option>
          <option>SOL_USDT</option>
        </select>
      </div>
      <div class="ms-auto mono small muted" id="filterNote"></div>
    </div>
  </div>

  <!-- Automatic Strategy Assignment -->
  <div class="card mb-3">
    <div class="card-body">
      <h2 class="h5 mb-3 section-title">Automatic Strategy Assignment</h2>
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="autoRebalanceToggle" />
          <label class="form-check-label" for="autoRebalanceToggle">
            Enable Auto-Assignment (Moves underperforming workers to best strategy every 60 bars)
          </label>
        </div>
        <button class="btn btn-sm btn-primary" id="manualRebalanceBtn">Trigger Now</button>
        <div class="ms-auto muted small" id="rebalanceStatus"></div>
      </div>
    </div>
  </div>

  <!-- Workers + filters -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0 section-title">Workers</h2>
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center gap-2">
            <label for="filterStrategy" class="muted small">Strategy</label>
            <select id="filterStrategy" class="form-select form-select-sm" style="width: 160px;">
              <option value="">All</option>
              <option value="MeanReversion">Mean Reversion</option>
              <option value="Breakout">Breakout</option>
              <option value="TrendFollow">Trend Follow</option>
            </select>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label for="filterSymbol" class="muted small">Symbol</label>
            <select id="filterSymbol" class="form-select form-select-sm" style="width: 160px;">
              <option value="">All</option>
              <option>BTC_USDT</option>
              <option>ETH_USDT</option>
              <option>SOL_USDT</option>
            </select>
          </div>
        </div>
      </div>
      <div id="workersTable"></div>
    </div>
  </div>

  <!-- Collapsible Positions -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="collapse-toggle d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#positionsCollapse">
        <h2 class="h6 mb-0 section-title">Open Positions</h2>
        <div class="d-flex align-items-center gap-2">
          <span class="mono small muted" id="positionsCount">-</span>
          <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
          </svg>
        </div>
      </div>
      <div class="collapse" id="positionsCollapse">
        <hr class="my-2" style="border-color: var(--panel-border);">
        <div id="positions"></div>
      </div>
    </div>
  </div>

  <!-- Collapsible Recent Trades -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="collapse-toggle d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#tradesCollapse">
        <h2 class="h6 mb-0 section-title">Recent Trades</h2>
        <div class="d-flex align-items-center gap-2">
          <span class="mono small muted" id="tradesCount">-</span>
          <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
          </svg>
        </div>
      </div>
      <div class="collapse" id="tradesCollapse">
        <hr class="my-2" style="border-color: var(--panel-border);">
        <div id="roundtrips"></div>
      </div>
    </div>
  </div>

  <!-- Strategy overview cards -->
  <div id="strategyOverview" class="mb-3"></div>

{% endblock %}

{% block scripts %}
  <script>
    const fmt2 = (x) => Number(x).toFixed(2);
    const pct = (x) => (Number(x) * 100).toFixed(2) + "%";
    const fmtTs = (ts) => new Date(ts * 1000).toLocaleString();
    const money = (x) => "$" + Number(x).toFixed(2);

    let currentPrices = {}; // { "BTC_USDT": {price, ts}, ... }
    let allWorkers = [];    // Flattened list of all workers with their strategy names
    let openPositions = [];

    function badge(val) {
      const c = Number(val);
      const cls = c >= 0 ? "badge-up" : "badge-down";
      const sign = c >= 0 ? "+" : "";
      return `<span class="badge ${cls}">${sign}${pct(c)}</span>`;
    }

    function renderSummary(snap) {
      const totalEq = snap.strategies.reduce((a, s) =>
        a + s.bots.reduce((bacc, b) => bacc + Number(b.equity), 0), 0
      );
      const totalTrades = snap.strategies.reduce((a, s) =>
        a + s.bots.reduce((bacc, b) => bacc + Number(b.trades), 0), 0
      );

      document.getElementById("summary").innerHTML = `
        <div class="card">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="muted small">Total Equity</div>
                <div class="mono h4 mb-0">$${fmt2(totalEq)}</div>
              </div>
              <div class="col-md-3">
                <div class="muted small">Total Workers</div>
                <div class="mono h4 mb-0">${allWorkers.length}</div>
              </div>
              <div class="col-md-3">
                <div class="muted small">Active Positions</div>
                <div class="mono h4 mb-0">${openPositions.length}</div>
              </div>
              <div class="col-md-3">
                <div class="muted small">Total Trades</div>
                <div class="mono h4 mb-0">${totalTrades}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderStrategyOverview(snap) {
      const strategies = snap.strategies.map(s => {
        const equity = s.bots.reduce((acc, b) => acc + Number(b.equity), 0);
        const avgScore = s.bots.reduce((acc, b) => acc + Number(b.score), 0) / s.bots.length;
        const workers = s.bots.length;
        return { name: s.name, equity, avgScore, workers };
      });

      const cards = strategies.map(s => `
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h3 class="h6 mb-0 text-capitalize">${s.name.replaceAll("_", " ")}</h3>
                ${badge(s.avgScore)}
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="muted small">Equity</div>
                  <div class="mono">$${fmt2(s.equity)}</div>
                </div>
                <div>
                  <div class="muted small">Workers</div>
                  <div class="mono">${s.workers}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join("");

      document.getElementById("strategyOverview").innerHTML = `
        <div class="card"><div class="card-body">
          <h2 class="h5 mb-3 section-title">Strategy Overview</h2>
          <div class="row g-3">${cards}</div>
        </div></div>
      `;
    }

    function renderWorkers() {
      const filterStrategy = document.getElementById("filterStrategy").value;
      const filterSymbol = document.getElementById("filterSymbol").value;

      const filtered = allWorkers.filter(w => {
        if (filterStrategy && w.strategyType !== filterStrategy) return false;
        if (filterSymbol && w.symbol !== filterSymbol) return false;
        return true;
      });

      const rows = filtered.map(w => {
        const hasPosition = openPositions.some(p => p.bot === w.name);
        const statusIcon = hasPosition
          ? '<span class="status-active">●</span>'
          : '<span class="status-idle">○</span>';

        return `
          <tr>
            <td class="mono">${statusIcon} ${w.name}</td>
            <td class="mono">${w.symbol}</td>
            <td class="mono">${w.strategyType}</td>
            <td class="mono">$${fmt2(w.equity)}</td>
            <td class="mono">${fmt2(w.allocation)}</td>
            <td>${badge(w.score)}</td>
            <td class="mono">${w.trades}</td>
            <td>
              <select class="form-select form-select-sm strategy-change" data-worker="${w.name}" style="width: 160px;">
                <option value="MeanReversion" ${w.strategyType === 'MeanReversion' ? 'selected' : ''}>Mean Reversion</option>
                <option value="Breakout" ${w.strategyType === 'Breakout' ? 'selected' : ''}>Breakout</option>
                <option value="TrendFollow" ${w.strategyType === 'TrendFollow' ? 'selected' : ''}>Trend Follow</option>
              </select>
            </td>
          </tr>
        `;
      }).join("");

      document.getElementById("workersTable").innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm table-dark table-striped align-middle">
            <thead>
              <tr>
                <th>Worker</th>
                <th>Symbol</th>
                <th>Strategy</th>
                <th>Equity</th>
                <th>Allocation</th>
                <th>Score</th>
                <th>Trades</th>
                <th>Change Strategy</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <div class="mt-2 muted small">
          Showing ${filtered.length} of ${allWorkers.length} workers
          ${filterStrategy || filterSymbol ? ' (filtered)' : ''}
        </div>
      `;

      // Attach change handlers
      document.querySelectorAll('.strategy-change').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const workerName = e.target.getAttribute('data-worker');
          const newStrategy = e.target.value;
          await changeWorkerStrategy(workerName, newStrategy);
        });
      });
    }

    async function changeWorkerStrategy(workerName, newStrategy) {
      try {
        const res = await fetch('/api/worker/strategy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ worker: workerName, strategy: newStrategy })
        });

        if (res.ok) {
          await load(); // refresh
        } else {
          const error = await res.json();
          alert(`Failed to change strategy: ${error.error || 'Unknown error'}`);
        }
      } catch (err) {
        console.error('Error changing strategy:', err);
        alert('Error changing strategy. See console for details.');
      }
    }

    function renderPositions(items) {
      document.getElementById("positionsCount").textContent = `${items.length} open`;

      if (items.length === 0) {
        document.getElementById("positions").innerHTML = '<div class="muted small">No open positions</div>';
        return;
      }

      const rows = items.map(p => {
        const mark = currentPrices[p.symbol]?.price;
        let unreal = "-";
        if (mark != null) {
          const qty = Number(p.qty);
          const avg = Number(p.avg_cost);
          const sideLong = p.side === "LONG";
          const pnl = sideLong ? (mark - avg) * qty : (avg - mark) * qty;
          unreal = "$" + pnl.toFixed(2);
        }
        return `
          <tr>
            <td class="mono">${p.bot}</td>
            <td class="mono">${p.symbol}</td>
            <td class="mono">${p.side}</td>
            <td class="mono">${Number(p.qty).toFixed(6)}</td>
            <td class="mono">${Number(p.avg_cost).toFixed(4)}</td>
            <td class="mono">${unreal}</td>
          </tr>
        `;
      }).join("");

      document.getElementById("positions").innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm table-dark table-striped align-middle">
            <thead><tr>
              <th>Worker</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Avg Cost</th><th>Unrealized P&L</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    async function loadPositions() {
      const res = await fetch('/positions.json', { cache: "no-store" });
      const data = await res.json();
      openPositions = data.items || [];
      renderPositions(openPositions);
    }

    function renderRoundtrips(items) {
      document.getElementById("tradesCount").textContent = `${items.length} recent`;

      if (items.length === 0) {
        document.getElementById("roundtrips").innerHTML = '<div class="muted small">No recent trades</div>';
        return;
      }

      const rows = items.slice(0, 20).map(rt => `
        <tr>
          <td class="mono small">${new Date(rt.close_ts*1000).toLocaleString()}</td>
          <td class="mono">${rt.bot}</td>
          <td class="mono">${rt.symbol}</td>
          <td class="mono">${rt.side}</td>
          <td class="mono">${(rt.pnl).toFixed(2)}</td>
          <td class="mono">${(rt.pnl_pct*100).toFixed(2)}%</td>
        </tr>
      `).join("");

      document.getElementById("roundtrips").innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm table-dark table-striped align-middle">
            <thead><tr>
              <th>Closed</th><th>Worker</th><th>Symbol</th><th>Side</th><th>P&L $</th><th>P&L %</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    async function loadRoundtrips() {
      const res = await fetch('/roundtrips.json?limit=20', { cache: "no-store" });
      const data = await res.json();
      renderRoundtrips(data.items || []);
    }

    async function loadPrices() {
      const res = await fetch('/prices.json', { cache: "no-store" });
      const data = await res.json();
      currentPrices = {};
      (data.items || []).forEach(p => { currentPrices[p.symbol] = { price: p.price, ts: p.ts }; });
    }

    async function load() {
      const res = await fetch('/portfolio.json', { cache: "no-store" });
      const snap = await res.json();

      // Flatten workers with strategy info
      allWorkers = [];
      snap.strategies.forEach(s => {
        s.bots.forEach(b => {
          allWorkers.push({
            name: b.name,
            symbol: b.symbol,
            tf: b.tf,
            equity: b.equity,
            score: b.score,
            trades: b.trades_db ?? b.trades,
            allocation: 0, // if/when provided
            strategyName: s.name,
            strategyType: b.name.startsWith('mr_') ? 'MeanReversion'
                        : b.name.startsWith('bo_') ? 'Breakout'
                        : 'TrendFollow'
          });
        });
      });

      renderSummary(snap);
      renderStrategyOverview(snap);
      renderWorkers();
    }

    // Auto-assign controls
    async function loadAutoRebalanceStatus() {
      try {
        const res = await fetch('/api/auto-rebalance');
        const data = await res.json();
        document.getElementById('autoRebalanceToggle').checked = data.enabled;
      } catch (err) {
        console.error('Error loading auto-rebalance status:', err);
      }
    }

    document.getElementById('autoRebalanceToggle')?.addEventListener('change', async (e) => {
      try {
        const enabled = e.target.checked;
        const res = await fetch('/api/auto-rebalance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        const data = await res.json();
        document.getElementById('rebalanceStatus').textContent = data.message;
        setTimeout(() => { document.getElementById('rebalanceStatus').textContent = ''; }, 3000);
      } catch (err) {
        console.error('Error toggling auto-rebalance:', err);
        alert('Error toggling auto-rebalance. See console for details.');
      }
    });

    document.getElementById('manualRebalanceBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('manualRebalanceBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';
      try {
        const res = await fetch('/api/auto-assign-strategies', { method: 'POST', headers: { 'Content-Type': 'application/json' }});
        const data = await res.json();
        if (data.success) {
          document.getElementById('rebalanceStatus').textContent =
            `Reassigned ${data.count} workers to ${data.best_strategy}`;
          setTimeout(() => { document.getElementById('rebalanceStatus').textContent = ''; }, 5000);
          await load();
        } else {
          alert('Auto-assignment failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error triggering auto-rebalance:', err);
        alert('Error triggering auto-rebalance. See console for details.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Trigger Now';
      }
    });

    // Filter handlers
    document.getElementById("filterStrategy").addEventListener("change", renderWorkers);
    document.getElementById("filterSymbol").addEventListener("change", renderWorkers);

    // Refresh controls
    let timer = null;
    const intervalSel = document.getElementById("interval");
    const autoChk = document.getElementById("autoRefresh");
    const refreshBtn = document.getElementById("refreshBtn");
    const tfTag = document.getElementById("tfTag");
    tfTag.textContent = "TF: 1m";

    function startLoop() {
      stopLoop();
      const ms = Number(intervalSel.value) * 1000;
      timer = setInterval(() => {
        load();
        loadPrices();
        loadPositions();
        loadRoundtrips();
      }, ms);
    }

    function stopLoop() {
      if (timer) { clearInterval(timer); timer = null; }
    }

    autoChk.addEventListener("change", () => { autoChk.checked ? startLoop() : stopLoop(); });
    intervalSel.addEventListener("change", () => { if (autoChk.checked) startLoop(); });
    refreshBtn.addEventListener("click", () => { load(); loadPrices(); loadPositions(); loadRoundtrips(); });

    // Initial load
    Promise.all([
      load(),
      loadPrices(),
      loadPositions(),
      loadRoundtrips(),
      loadAutoRebalanceStatus()
    ]).then(() => {
      if (autoChk.checked) startLoop();
    });
  </script>
{% endblock %}
