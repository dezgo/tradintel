{% extends "base.html" %}

{% block title %}TradingBot — Portfolio{% endblock %}
{% block page_title %}TradingBot — Portfolio{% endblock %}
{% set active_page = 'portfolio' %}

{% block extra_styles %}
  /* Badges (stronger contrast) */
  .badge-up   { background: #062a1a; color: var(--text); border: 1px solid var(--green); }
  .badge-down { background: #2c0b0b; color: var(--text); border: 1px solid var(--red); }
  .badge-active { background: #1e3a8a; color: var(--text); border: 1px solid var(--blue); }

  /* Section headers & muted bits */
  .section-title { color: var(--text); opacity: 0.95; }

  /* Custom select styling */
  .form-select-sm { background-color: var(--panel); color: var(--text); border-color: var(--panel-border); }
  .form-select-sm:focus { background-color: var(--panel); color: var(--text); border-color: var(--blue); }

  /* Worker status indicators */
  .status-active { color: var(--green); }
  .status-idle { color: var(--text-muted); }

  /* Collapsible sections */
  .collapse-toggle { cursor: pointer; user-select: none; }
  .collapse-toggle:hover { opacity: 0.8; }
{% endblock %}

{% block extra_nav %}
  <span class="muted small">Auto-refresh</span>
  <div class="form-check form-switch">
    <input class="form-check-input" type="checkbox" id="autoRefresh" checked />
  </div>
  <select id="interval" class="form-select form-select-sm" style="width:120px">
    <option value="3">3s</option>
    <option value="5" selected>5s</option>
    <option value="10">10s</option>
  </select>
  <button class="btn btn-sm btn-outline-light" id="refreshBtn">Refresh</button>
  <span class="mono small muted" id="tfTag"></span>
{% endblock %}

{% block content %}

  <!-- KPI Cards -->
  <div class="row g-2 g-md-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="card text-center" style="padding: 1.5rem 1rem;">
        <div class="muted small text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Total Equity</div>
        <div class="mono" style="font-size: 2rem; font-weight: 600; color: var(--text);" id="kpiEquity">$0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center" style="padding: 1.5rem 1rem;">
        <div class="muted small text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Active Workers</div>
        <div class="mono" style="font-size: 2rem; font-weight: 600; color: var(--text);" id="kpiWorkers">0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center" style="padding: 1.5rem 1rem;">
        <div class="muted small text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Open Positions</div>
        <div class="mono" style="font-size: 2rem; font-weight: 600; color: var(--text);" id="kpiPositions">0</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center" style="padding: 1.5rem 1rem;">
        <div class="muted small text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Total Trades</div>
        <div class="mono" style="font-size: 2rem; font-weight: 600; color: var(--text);" id="kpiTrades">0</div>
      </div>
    </div>
  </div>

  <!-- Exchange Balance -->
  <div class="card mb-3" id="exchangeBalanceCard" style="display: none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 mb-0">Exchange Balance <span class="badge badge-active" id="executionMode" style="font-size: 0.7rem; margin-left: 0.5rem;">LOADING</span></h2>
        <button class="btn btn-sm btn-outline-secondary" onclick="loadExchangeBalance()">↻ Refresh</button>
      </div>
      <div id="exchangeBalanceContent"></div>
    </div>
  </div>

  <!-- Strategy Performance -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 mb-0">Strategy Performance</h2>
        <button type="button" class="btn btn-link btn-sm" data-bs-toggle="modal" data-bs-target="#workersModal">View All Workers →</button>
      </div>
      <div id="strategyBars"></div>
    </div>
  </div>

  <!-- Auto-Rebalance -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" id="autoRebalanceToggle" />
            <label class="form-check-label small" for="autoRebalanceToggle">
              Auto-assign to best strategy
            </label>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="muted small" id="rebalanceStatus"></span>
          <button class="btn btn-sm btn-primary" id="manualRebalanceBtn">Rebalance Now</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fee Statistics -->
  <div class="card mb-3">
    <div class="card-body">
      <h2 class="h6 mb-3">Trading Fees</h2>
      <div class="row g-2">
        <div class="col-6 col-md-3">
          <div class="text-center p-2" style="background: var(--page-bg); border-radius: 6px;">
            <div class="muted small mb-1">Total Fees</div>
            <div class="mono" style="font-size: 1.25rem; font-weight: 600; color: var(--red);" id="feesTotal">$0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2" style="background: var(--page-bg); border-radius: 6px;">
            <div class="muted small mb-1">Maker Ratio</div>
            <div class="mono" style="font-size: 1.25rem; font-weight: 600; color: var(--green);" id="feesMakerRatio">0%</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2" style="background: var(--page-bg); border-radius: 6px;">
            <div class="muted small mb-1">Fee Rate</div>
            <div class="mono" style="font-size: 1.25rem; font-weight: 600;" id="feesRate">0%</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-center p-2" style="background: var(--page-bg); border-radius: 6px;">
            <div class="muted small mb-1">Volume</div>
            <div class="mono" style="font-size: 1.25rem; font-weight: 600; color: var(--text);" id="feesVolume">$0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="row g-2 g-md-3">
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-body">
          <h2 class="h6 mb-3">Open Positions <span class="muted small" id="posCount">(0)</span></h2>
          <div id="recentPositions"></div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-body">
          <h2 class="h6 mb-3">Recent Trades <span class="muted small" id="tradesCount">(0)</span></h2>
          <div id="recentTrades"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Workers Modal -->
  <div class="modal fade" id="workersModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content" style="background: var(--panel); color: var(--text); border: 1px solid var(--panel-border);">
        <div class="modal-header" style="border-bottom: 1px solid var(--panel-border);">
          <h5 class="modal-title">All Workers</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex gap-2 flex-wrap">
            <select id="filterStrategy" class="form-select form-select-sm" style="width: 160px;">
              <option value="">All Strategies</option>
              <option value="MeanReversion">Mean Reversion</option>
              <option value="Breakout">Breakout</option>
              <option value="TrendFollow">Trend Follow</option>
            </select>
            <select id="filterSymbol" class="form-select form-select-sm" style="width: 140px;">
              <option value="">All Symbols</option>
              <option>BTC_USDT</option>
              <option>ETH_USDT</option>
              <option>SOL_USDT</option>
            </select>
          </div>
          <div id="workersTable"></div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script>
    const fmt2 = (x) => Number(x).toFixed(2);
    const pct = (x) => (Number(x) * 100).toFixed(2) + "%";
    const fmtTs = (ts) => new Date(ts * 1000).toLocaleString();
    const money = (x) => "$" + Number(x).toFixed(2);

    let currentPrices = {}; // { "BTC_USDT": {price, ts}, ... }
    let allWorkers = [];    // Flattened list of all workers with their strategy names
    let openPositions = [];

    function badge(val) {
      const c = Number(val);
      const cls = c >= 0 ? "badge-up" : "badge-down";
      const sign = c >= 0 ? "+" : "";
      return `<span class="badge ${cls}">${sign}${pct(c)}</span>`;
    }

    function updateKPIs(snap) {
      const totalEq = snap.strategies.reduce((a, s) =>
        a + s.bots.reduce((bacc, b) => bacc + Number(b.equity), 0), 0
      );
      const totalTrades = snap.strategies.reduce((a, s) =>
        a + s.bots.reduce((bacc, b) => bacc + Number(b.trades), 0), 0
      );
      const activeWorkers = allWorkers.filter(w =>
        openPositions.some(p => p.bot === w.name)
      ).length;

      document.getElementById("kpiEquity").textContent = money(totalEq);
      document.getElementById("kpiWorkers").textContent = `${activeWorkers}/${allWorkers.length}`;
      document.getElementById("kpiPositions").textContent = openPositions.length;
      document.getElementById("kpiTrades").textContent = totalTrades;
    }

    function renderStrategyBars(snap) {
      const strategies = snap.strategies.map(s => {
        const equity = s.bots.reduce((acc, b) => acc + Number(b.equity), 0);
        const avgScore = s.bots.reduce((acc, b) => acc + Number(b.score), 0) / s.bots.length;
        const workers = s.bots.length;
        const activeWorkers = s.bots.filter(b =>
          openPositions.some(p => p.bot === b.name)
        ).length;
        return { name: s.name, equity, avgScore, workers, activeWorkers };
      });

      const bars = strategies.map(s => {
        const scoreClass = s.avgScore >= 0 ? 'badge-up' : 'badge-down';
        const sign = s.avgScore >= 0 ? '+' : '';
        return `
          <div style="display: flex; align-items: center; padding: 0.75rem 1rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 6px; border-left: 3px solid var(--blue);">
            <div style="flex: 1; font-weight: 500;">${s.name.replaceAll("_", " ")}</div>
            <div style="display: flex; gap: 1.5rem; align-items: center;">
              <div style="text-align: right;">
                <div class="muted" style="font-size: 0.7rem; opacity: 0.7;">Workers</div>
                <div class="mono" style="font-weight: 600;">${s.activeWorkers}/${s.workers}</div>
              </div>
              <div style="text-align: right;">
                <div class="muted" style="font-size: 0.7rem; opacity: 0.7;">Equity</div>
                <div class="mono" style="font-weight: 600;">${money(s.equity)}</div>
              </div>
              <div style="text-align: right;">
                <div class="muted" style="font-size: 0.7rem; opacity: 0.7;">Score</div>
                <div style="font-weight: 600;">
                  <span class="badge ${scoreClass}">${sign}${pct(s.avgScore)}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      document.getElementById("strategyBars").innerHTML = bars;
    }

    function renderWorkers() {
      const filterStrategy = document.getElementById("filterStrategy")?.value || "";
      const filterSymbol = document.getElementById("filterSymbol")?.value || "";

      const filtered = allWorkers.filter(w => {
        if (filterStrategy && w.strategyType !== filterStrategy) return false;
        if (filterSymbol && w.symbol !== filterSymbol) return false;
        return true;
      });

      const rows = filtered.map(w => {
        const hasPosition = openPositions.some(p => p.bot === w.name);
        const statusDot = hasPosition
          ? '<span style="color: var(--green)">●</span>'
          : '<span style="color: var(--text-muted)">○</span>';
        const scoreClass = w.score >= 0 ? 'badge-up' : 'badge-down';
        const sign = w.score >= 0 ? '+' : '';

        return `
          <tr style="border-bottom: 1px solid var(--panel-border);">
            <td class="py-2">${statusDot}</td>
            <td class="py-2 mono small">${w.name}</td>
            <td class="py-2 mono">${w.symbol}</td>
            <td class="py-2">${w.strategyType}</td>
            <td class="py-2 mono">${money(w.equity)}</td>
            <td class="py-2"><span class="badge ${scoreClass}">${sign}${pct(w.score)}</span></td>
            <td class="py-2 mono">${w.trades}</td>
            <td class="py-2">
              <select class="form-select form-select-sm strategy-change" data-worker="${w.name}" style="width: 150px; font-size: 0.75rem;">
                <option value="MeanReversion" ${w.strategyType === 'MeanReversion' ? 'selected' : ''}>Mean Reversion</option>
                <option value="Breakout" ${w.strategyType === 'Breakout' ? 'selected' : ''}>Breakout</option>
                <option value="TrendFollow" ${w.strategyType === 'TrendFollow' ? 'selected' : ''}>Trend Follow</option>
              </select>
            </td>
          </tr>
        `;
      }).join("");

      document.getElementById("workersTable").innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm mb-0" style="color: var(--text);">
            <thead style="border-bottom: 2px solid var(--panel-border);">
              <tr>
                <th></th>
                <th class="small">Worker</th>
                <th class="small">Symbol</th>
                <th class="small">Strategy</th>
                <th class="small">Equity</th>
                <th class="small">Score</th>
                <th class="small">Trades</th>
                <th class="small">Change To</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="8" class="text-center py-3 muted">No workers found</td></tr>'}</tbody>
          </table>
        </div>
        <div class="mt-2 muted small">
          ${filtered.length} of ${allWorkers.length} workers ${filterStrategy || filterSymbol ? '(filtered)' : ''}
        </div>
      `;

      // Attach change handlers
      document.querySelectorAll('.strategy-change').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const workerName = e.target.getAttribute('data-worker');
          const newStrategy = e.target.value;
          await changeWorkerStrategy(workerName, newStrategy);
        });
      });
    }

    async function changeWorkerStrategy(workerName, newStrategy) {
      try {
        const res = await fetch('/api/worker/strategy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ worker: workerName, strategy: newStrategy })
        });

        if (res.ok) {
          await load(); // refresh
        } else {
          const error = await res.json();
          alert(`Failed to change strategy: ${error.error || 'Unknown error'}`);
        }
      } catch (err) {
        console.error('Error changing strategy:', err);
        alert('Error changing strategy. See console for details.');
      }
    }

    function renderRecentPositions(items) {
      document.getElementById("posCount").textContent = `(${items.length})`;

      if (items.length === 0) {
        document.getElementById("recentPositions").innerHTML = '<div class="muted small">No open positions</div>';
        return;
      }

      const list = items.slice(0, 5).map(p => {
        const mark = currentPrices[p.symbol]?.price;
        let pnl = 0;
        if (mark != null) {
          const qty = Number(p.qty);
          const avg = Number(p.avg_cost);
          const sideLong = p.side === "LONG";
          pnl = sideLong ? (mark - avg) * qty : (avg - mark) * qty;
        }
        const pnlClass = pnl >= 0 ? 'badge-up' : 'badge-down';

        return `
          <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--panel-border);">
            <div>
              <div class="mono small">${p.symbol} ${p.side}</div>
              <div class="muted small">${p.bot}</div>
            </div>
            <div class="text-end">
              <div class="mono small">${Number(p.qty).toFixed(4)}</div>
              <div><span class="badge ${pnlClass}">${money(pnl)}</span></div>
            </div>
          </div>
        `;
      }).join("");

      document.getElementById("recentPositions").innerHTML = list;
    }

    async function loadPositions() {
      const res = await fetch('/positions.json', { cache: "no-store" });
      const data = await res.json();
      openPositions = data.items || [];
      renderRecentPositions(openPositions);
    }

    function renderRecentTrades(items) {
      document.getElementById("tradesCount").textContent = `(${items.length})`;

      if (items.length === 0) {
        document.getElementById("recentTrades").innerHTML = '<div class="muted small">No recent trades</div>';
        return;
      }

      const list = items.slice(0, 5).map(rt => {
        const pnlClass = rt.pnl >= 0 ? 'badge-up' : 'badge-down';
        const sign = rt.pnl >= 0 ? '+' : '';
        return `
          <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--panel-border);">
            <div>
              <div class="mono small">${rt.symbol} ${rt.side}</div>
              <div class="muted small">${new Date(rt.close_ts*1000).toLocaleTimeString()}</div>
            </div>
            <div class="text-end">
              <div class="mono small">${rt.bot}</div>
              <div><span class="badge ${pnlClass}">${sign}${money(rt.pnl)}</span></div>
            </div>
          </div>
        `;
      }).join("");

      document.getElementById("recentTrades").innerHTML = list;
    }

    async function loadRoundtrips() {
      const res = await fetch('/roundtrips.json?limit=20', { cache: "no-store" });
      const data = await res.json();
      renderRecentTrades(data.items || []);
    }

    async function loadPrices() {
      const res = await fetch('/prices.json', { cache: "no-store" });
      const data = await res.json();
      currentPrices = {};
      (data.items || []).forEach(p => { currentPrices[p.symbol] = { price: p.price, ts: p.ts }; });
    }

    async function load() {
      const res = await fetch('/portfolio.json', { cache: "no-store" });
      const snap = await res.json();

      // Flatten workers with strategy info
      allWorkers = [];
      snap.strategies.forEach(s => {
        s.bots.forEach(b => {
          allWorkers.push({
            name: b.name,
            symbol: b.symbol,
            tf: b.tf,
            equity: b.equity,
            score: b.score,
            trades: b.trades_db ?? b.trades,
            allocation: 0,
            strategyName: s.name,
            strategyType: b.name.startsWith('mr_') ? 'MeanReversion'
                        : b.name.startsWith('bo_') ? 'Breakout'
                        : 'TrendFollow'
          });
        });
      });

      updateKPIs(snap);
      renderStrategyBars(snap);
    }

    // Auto-assign controls
    async function loadAutoRebalanceStatus() {
      try {
        const res = await fetch('/api/auto-rebalance');
        const data = await res.json();
        document.getElementById('autoRebalanceToggle').checked = data.enabled;
      } catch (err) {
        console.error('Error loading auto-rebalance status:', err);
      }
    }

    document.getElementById('autoRebalanceToggle')?.addEventListener('change', async (e) => {
      try {
        const enabled = e.target.checked;
        const res = await fetch('/api/auto-rebalance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        const data = await res.json();
        document.getElementById('rebalanceStatus').textContent = data.message;
        setTimeout(() => { document.getElementById('rebalanceStatus').textContent = ''; }, 3000);
      } catch (err) {
        console.error('Error toggling auto-rebalance:', err);
        alert('Error toggling auto-rebalance. See console for details.');
      }
    });

    document.getElementById('manualRebalanceBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('manualRebalanceBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';
      try {
        const res = await fetch('/api/auto-assign-strategies', { method: 'POST', headers: { 'Content-Type': 'application/json' }});
        const data = await res.json();
        if (data.success) {
          document.getElementById('rebalanceStatus').textContent =
            `Reassigned ${data.count} workers to ${data.best_strategy}`;
          setTimeout(() => { document.getElementById('rebalanceStatus').textContent = ''; }, 5000);
          await load();
        } else {
          alert('Auto-assignment failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error triggering auto-rebalance:', err);
        alert('Error triggering auto-rebalance. See console for details.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Trigger Now';
      }
    });

    // Workers modal event
    document.getElementById('workersModal')?.addEventListener('show.bs.modal', () => {
      renderWorkers();
    });

    // Filter handlers (in modal)
    document.getElementById("filterStrategy")?.addEventListener("change", renderWorkers);
    document.getElementById("filterSymbol")?.addEventListener("change", renderWorkers);

    // Refresh controls
    let timer = null;
    const intervalSel = document.getElementById("interval");
    const autoChk = document.getElementById("autoRefresh");
    const refreshBtn = document.getElementById("refreshBtn");
    const tfTag = document.getElementById("tfTag");
    tfTag.textContent = "TF: 1m";

    async function loadFees() {
      try {
        const res = await fetch('/fees.json', { cache: "no-store" });
        const data = await res.json();

        document.getElementById("feesTotal").textContent = money(data.total_fees);
        document.getElementById("feesMakerRatio").textContent = pct(data.maker_ratio);
        document.getElementById("feesRate").textContent = data.fee_percentage.toFixed(3) + '%';
        document.getElementById("feesVolume").textContent = money(data.total_volume);
      } catch (err) {
        console.error('Error loading fees:', err);
      }
    }

    async function loadExchangeBalance() {
      try {
        const res = await fetch('/exchange-balance.json', { cache: "no-store" });
        const data = await res.json();

        // Update execution mode badge
        const modeElement = document.getElementById("executionMode");
        modeElement.textContent = data.mode.toUpperCase();

        if (data.mode === "paper") {
          modeElement.className = "badge badge-down";
          document.getElementById("exchangeBalanceCard").style.display = "none";
          return;
        } else {
          modeElement.className = "badge badge-up";
          document.getElementById("exchangeBalanceCard").style.display = "block";
        }

        // Render balances
        const content = document.getElementById("exchangeBalanceContent");

        if (data.error) {
          content.innerHTML = `<div class="text-danger small">Error: ${data.error}</div>`;
          return;
        }

        if (data.balances.length === 0) {
          content.innerHTML = '<div class="muted small">No funds in account</div>';
          return;
        }

        // Display balances in a grid
        const balanceHtml = `
          <div class="row g-2">
            ${data.balances.map(bal => `
              <div class="col-6 col-md-3">
                <div style="background: var(--page-bg); border-radius: 6px; padding: 0.75rem;">
                  <div class="muted small">${bal.asset}</div>
                  <div class="mono" style="font-size: 1.25rem; font-weight: 600;">${bal.total.toFixed(8)}</div>
                  <div class="muted" style="font-size: 0.7rem;">
                    Free: ${bal.free.toFixed(8)}
                    ${bal.locked > 0 ? `<br>Locked: ${bal.locked.toFixed(8)}` : ''}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        content.innerHTML = balanceHtml;

      } catch (err) {
        console.error('Error loading exchange balance:', err);
      }
    }

    function refreshAll() {
      load();
      loadPrices();
      loadPositions();
      loadRoundtrips();
      loadFees();
      loadExchangeBalance();
    }

    function startLoop() {
      stopLoop();
      const ms = Number(intervalSel.value) * 1000;
      timer = setInterval(refreshAll, ms);
    }

    function stopLoop() {
      if (timer) { clearInterval(timer); timer = null; }
    }

    autoChk.addEventListener("change", () => { autoChk.checked ? startLoop() : stopLoop(); });
    intervalSel.addEventListener("change", () => { if (autoChk.checked) startLoop(); });
    refreshBtn.addEventListener("click", refreshAll);

    // Initial load
    Promise.all([
      load(),
      loadPrices(),
      loadPositions(),
      loadRoundtrips(),
      loadAutoRebalanceStatus(),
      loadFees(),
      loadExchangeBalance()
    ]).then(() => {
      if (autoChk.checked) startLoop();
    });
  </script>
{% endblock %}
